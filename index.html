<!DOCTYPE html>
<html>
<head>
    <title>Borderlands 4 Serial Comparator</title>
    <script src="https://unpkg.com/vue@3.5.22/dist/vue.global.js"></script>
</head>

<body>

<style>
    html, body {
        height: 100%;
        margin: 0;
        display: flex;
        justify-content: center;
        font-family: Arial, sans-serif;
        background-color: #191919;
        color: white;
        font-size: 18px;
    }

    #app {
        position: absolute;
        display: block;
        width: 100%;
        left: 0;
        height: 100%;
        top: 0;
    }

    .hiddenByDefault {
        display: none;
    }

    .hiddenByDefault.hasLoaded {
        display: block;
    }

    #header {
        position: fixed;
        z-index: 9999;
        width: calc(100% - 32px);
        /*background-color: #1A2224;*/
        background: #1B2029;
        background: linear-gradient(90deg, rgba(27, 32, 41, 1) 0%, rgba(43, 27, 27, 1) 19%, rgba(39, 29, 26, 1) 35%, rgba(35, 30, 26, 1) 54%, rgba(43, 26, 29, 1) 72%, rgba(28, 31, 42, 1) 83%, rgba(26, 33, 40, 1) 100%);
        padding-bottom: 9px;
        padding-left: 16px;
        padding-right: 16px;
        padding-top: 10px;
    }

    .header-title {
        display: inline-block;
        font-size: 17px;
        padding-bottom: 4px;
    }

    .header-input {
        color: rgba(255, 255, 255, 0.70);
        background-color: rgba(255, 255, 255, 0.08);
        border: 1px solid transparent;
        border-radius: 8px;
        width: calc(100% - 18px);
        padding-top: 6px;
        padding-bottom: 6px;
        padding-left: 9px;
        padding-right: 9px;
        font-size: 16px;
        font-family: monospace;
        height: 20px;
        resize: none;
    }

    .header-input:focus {
        outline: none;
        background-color: rgba(0, 0, 0, 0.27);
        border: 1px solid rgba(255, 255, 255, 0.09);
    }

    #serials {
        display: block;
        position: absolute;
        padding-top: 16px;
        top: 94px;
        bottom: 0;
        left: 0;
        right: 0;
        overflow-x: auto;
        padding-bottom: 24px;
    }

    .serial-container {
        position: relative;
        display: table;
        /*background-color: rgba(255, 255, 255, 0.05);*/
        border: 1px solid #333;
        border-radius: 8px;
        padding: 12px;
        margin: 12px;
        font-size: 17px;

        letter-spacing: 0.03rem;
        /*font-family: monospace;*/
    }

    .serial-b85 {
        font-family: monospace;
        user-select: all;
        -webkit-user-select: all;
        -moz-user-select: all;
        -ms-user-select: all;
        color: #aaa;
        font-size: 16px;
    }

    .select-all {
        user-select: all;
        -webkit-user-select: all;
        -moz-user-select: all;
        -ms-user-select: all;
    }

    .serial-b16 {
        font-family: monospace;
        color: #ccc;
    }

    .serial-b02 {
        font-family: monospace;
        color: #eee;
    }

    .bigger {
        font-size: 20px;
    }

    .confbutton {
        margin-top: 8px;
        height: 22px;
        padding: 0;
        padding-left: 5px;
        padding-right: 5px;
        background-color: rgba(0, 0, 0, 0.5);
        color: #999;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.17);
    }

    .confbutton.isred:not(:disabled) {
        background-color: rgba(175, 80, 76, 0.3);
        color: #AF504C;
        border: 1px solid #AF504C;
    }

    .confbutton.isred:not(:disabled):hover {
        background-color: rgba(175, 80, 76, 0.5);
        color: #BB666A;
    }

    .confbutton.isred:not(:disabled):active {
        background-color: rgba(175, 80, 76, 0.7);
    }

    .confinput {
        margin-top: 8px;
        height: 22px;
        padding: 0;
        padding-left: 5px;
        padding-right: 5px;
        background-color: rgba(0, 0, 0, 0.5);
        color: #999;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.17);
        outline: none;
        font-family: monospace;
    }

    .confinput:focus {
        background-color: rgba(0, 0, 0, 0.7);
        color: #ddd;
        border: 1px solid rgba(255, 255, 255, 0.27);
    }

    .confinput.invalid {
        border: 1px solid #F44336;
        color: #F44336;
    }

    .confinput.valid:focus {
        border: 1px solid #4CAF50;
        color: #4CAF50;
    }

    .confinput:disabled {
        background-color: rgba(0, 0, 0, 0.09);
        color: #555;
        border: 1px solid rgba(255, 255, 255, 0.07);
        cursor: not-allowed;
    }

    .confbutton.pulled-right {
        float: right;
    }

    .confbutton:hover {
        background-color: rgba(0, 0, 0, 0.7);
        color: #ddd;
        cursor: pointer;
    }

    .confbutton:active {
        background-color: rgba(0, 0, 0, 0.9);
        color: white;
    }

    .confbutton:disabled {
        background-color: rgba(0, 0, 0, 0.09);
        color: #555;
        border: 1px solid rgba(255, 255, 255, 0.07);
        cursor: not-allowed;
    }

    .serial-select-checkbox {
        position: absolute;
        top: -7px;
        left: -7px;
        transform: scale(1.1);
    }

    .serial-input-description {
        width: 450px;
        height: 17px;
        font-size: 14px;
        margin-bottom: 6px;
        color: #ddd;
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid transparent;
        border-radius: 6px;
        padding-left: 6px;
        padding-right: 6px;
        padding-top: 1px;
        padding-bottom: 1px;
    }

    .comparison-match {
        color: #aaa;
    }

    .comparison-diff {
        color: #F44336;

    }

    .comparison-add {
        color: #FF9800;
    }

    .dataset-list-container {
        position: fixed;
        z-index: 99;
        top: 150px;
        left: 50%;
        transform: translateX(-50%);
        width: 600px;
        background-color: #000;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 24px;

        max-height: 70vh;
        overflow-y: auto;
    }

    .dataset-list-title {
        font-size: 20px;
        margin-bottom: 20px;
        color: #fff;
        text-align: center;
    }

    .dataset-item {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding-top: 9px;
        padding-bottom: 9px;
        padding-left: 12px;
        padding-right: 12px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .dataset-info {
        flex-grow: 1;
    }

    .dataset-name {
        font-size: 16px;
        color: #fff;
        margin-bottom: 4px;
    }

    .dataset-count {
        font-size: 13px;
        color: #999;
    }

    .dataset-load-btn {
        padding: 8px 16px;
        background-color: rgba(76, 175, 80, 0.3);
        color: #4CAF50;
        border: 1px solid #4CAF50;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
    }

    .dataset-load-btn:hover {
        background-color: rgba(76, 175, 80, 0.5);
        color: #66BB6A;
    }

    .dataset-load-btn:active {
        background-color: rgba(76, 175, 80, 0.7);
    }

    .dataset-load-btn:disabled {
        background-color: rgba(76, 76, 76, 0.1);
        color: #555;
        border: 1px solid #555;
        cursor: not-allowed;
    }

    .dataset-close-btn {
        padding: 8px 16px;
        background-color: rgba(175, 80, 76, 0.3);
        color: #AF504C;
        border: 1px solid #AF504C;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
    }

    .dataset-close-btn:hover {
        background-color: rgba(175, 80, 76, 0.5);
        color: #BB666A;
    }

    .dataset-close-btn:active {
        background-color: rgba(175, 80, 76, 0.7);
    }

    .b02-level-bits {
        text-decoration: underline;
        text-decoration-color: #4CAF50;
        text-underline-offset: 1px;
        text-decoration-thickness: 4px;
    }
</style>

<div id="app" class="hiddenByDefault" :class="{hasLoaded: true}">
    <div
        id="header"
        v-on:mouseenter="mouseInsideHeader = true"
        v-on:mouseleave="mouseInsideHeader = false"
    >
        <span class="header-title">
            Borderlands 4 Serial Comparator

            <a style="margin-left: 24px;font-size: 14px;color: #555;" href="https://gitlab.nicnl.com/Nicnl/borderlands_4_item_tinker">https://gitlab.nicnl.com/Nicnl/borderlands_4_item_tinker</a>
        </span>
        <br/>
        <textarea
            class="header-input"
            v-bind:placeholder="placeholder"
            v-on:keypress="preventTyping"
            v-on:paste="onPaste"
            v-model="inputSerial"
        ></textarea>
        <button
            class="confbutton pulled-right"
            style="width: 170px;"
            v-on:click="clickToggleAutoscroll"
            v-bind:disabled="selectedSerials > 0 || focused"
        >Auto horizontal scroll: {{ autoscrollEnabled && selectedSerials === 0 && !focused ? 'yes' : 'no' }}</button>
        <button
            style="margin-left: 12px;width: 105px;"
            class="confbutton"
            v-bind:disabled="comparisonEnabled || displayYamlResult !== null || serials.length === 0"
            v-on:click="toggleSelectAll"
        >{{ allSelected ? 'Unselect all' : 'Select all' }}</button>
        <button
            style="margin-left: 12px;width: 150px;"
            class="confbutton isred"
            v-bind:disabled="selectedSerials === 0 || comparisonEnabled || displayYamlResult !== null"
            v-on:click="serials = serials.filter(s => !s.selected)"
        >{{ selectedSerials === 0 ? 'Select serials to delete' : ('Delete ' + selectedSerials + ' serial' + (selectedSerials > 1 ? 's' : '')) }}</button>
        <button
            v-if="comparisonEnabled"
            style="margin-left: 12px;width: 170px;"
            class="confbutton"
            v-on:click="stopComparingSerials"
        >Stop comparing serials</button>
        <button
            v-else
            style="margin-left: 12px;width: 170px;"
            class="confbutton"
            v-bind:disabled="selectedSerials < 2 || displayYamlResult !== null"
            v-on:click="openComparisonWindow"
        >{{ selectedSerials >= 2 ? 'Compare ' + selectedSerials + ' serials' : 'Select serial to compare' }}</button>
        <button
            v-if="displayYamlResult"
            style="margin-left: 12px;width: 165px;"
            class="confbutton"
            v-on:click="displayYamlResult = null"
        >Close YAML</button>
        <button
            v-else
            style="margin-left: 12px;width: 165px;"
            class="confbutton"
            v-bind:disabled="selectedSerials !== 1"
            v-on:click="bitswapSerial"
        >{{ selectedSerials === 1 ? 'Bitswap serial' : 'Select serial to bitswap' }}</button>
        <button
            style="margin-left: 12px;width: 105px;"
            class="confbutton"
            v-bind:disabled="comparisonEnabled || displayYamlResult !== null"
            v-on:click="showDatasetList = !showDatasetList"
        >{{ showDatasetList ? 'Close datasets' : 'Load dataset' }}</button>

        <span>
            <span style="font-size: 12px;color: #888;margin-left: 16px;margin-right: 4px;">Byte order:</span>
            <input
                type="text"
                style="width: 30px;"
                class="confinput"
                v-bind:class="{'invalid': !byteOrderValid, 'valid': byteOrderValid}"
                v-model="byteOrder"
                v-on:blur="byteOrderBlur"
                v-on:focus="byteOrderFocus"
                :disabled="displayYamlResult !== null"
                maxlength="4"
            />
        </span>

        <button
            style="margin-left: 12px;width: 120px;"
            class="confbutton"
            :disabled="displayYamlResult !== null"
            v-on:click="reverseBitsButton"
        >{{ 'Reverse bits: ' + (reverseBits ? 'yes' : 'no') }}</button>

        <button
            v-if="displayYamlResult === null"
            style="margin-left: 12px;width: 120px;"
            class="confbutton"
            :disabled="selectedSerials === 0 || comparisonEnabled"
            v-on:click="exportSelectedToYaml"
        >Export to YAML</button>
    </div>

    <div id="serials" ref="serialsDiv">
        <!-- Dataset List Overlay -->
        <div v-if="showDatasetList" class="dataset-list-container">
            <div class="dataset-list-title">Load Dataset</div>

            <div v-for="(dataset, i) in availableDatasets" :key="'dataset_for_' + i" class="dataset-item">
                <div class="dataset-info">
                    <div class="dataset-name">{{ dataset.name }}</div>
                    <div class="dataset-count">{{ dataset.items.length }} items</div>
                </div>
                <button class="dataset-load-btn" v-on:click="loadDataset(dataset)">Load</button>
            </div>

            <div style="text-align: center;">
                <button class="dataset-close-btn" v-on:click="showDatasetList = false">Close</button>
            </div>
        </div>

        <div v-if="displayYamlResult !== null" class="serial-container">
            <pre class="select-all">{{ displayYamlResult }}</pre>
        </div>

        <section v-else-if="comparisonEnabled">
            <!-- Base 85 Block -->
            <div class="serial-container">
                <div v-for="(serial, idx) in comparisonSerials" :key="'desc-b85-' + idx">
                    <span v-if="comparisonSerials.length > 2" style="font-size: 14px;color: #888;">{{ serial.description }} - Match: {{Math.round(serial.statsB85.matches / serial.statsB85.total * 100)}}% / Diff: {{Math.round(serial.statsB85.differences / serial.statsB85.total * 100)}}% / Added: {{Math.round(serial.statsB85.additions / serial.statsB85.total * 100)}}%</span>
                    <span v-else style="font-size: 14px;color: #888;">{{ serial.description }}</span><br/>
                    <span class="serial-b85 bigger">
                        <span v-for="(c, i) in serial.b85" :class="comparisonClass(serial.comparisonB85[i])">{{c}}</span>
                    </span><br/>
                </div>
                <br/>
                <span style="font-size: 14px;color: #888;">Overall - Match: {{Math.round(comparisonStatsB85.matches / comparisonStatsB85.total * 100)}}% / Diff: {{Math.round(comparisonStatsB85.differences / comparisonStatsB85.total * 100)}}% / Added: {{Math.round(comparisonStatsB85.additions / comparisonStatsB85.total * 100)}}%</span><br/>
                <span class="serial-b85 bigger">
                    <span v-for="(c, i) in comparisonStringB85" :class="comparisonClass(c)">{{c}}</span>
                </span><br/>
            </div>

            <!-- Base 16 Block -->
            <div class="serial-container">
                <div v-for="(serial, idx) in comparisonSerials" :key="'desc-b16-' + idx">
                    <span v-if="comparisonSerials.length > 2" style="font-size: 12px;color: #888;">Match: {{Math.round(serial.statsB16.matches / serial.statsB16.total * 100)}}% / Diff: {{Math.round(serial.statsB16.differences / serial.statsB16.total * 100)}}% / Added: {{Math.round(serial.statsB16.additions / serial.statsB16.total * 100)}}% <span style="margin-left: 24px;"></span> {{ serial.description }}</span>
                    <span v-else style="font-size: 12px;color: #888;">{{ serial.description }}</span><br/>
                    <span class="serial-b16 bigger">
                        <span v-for="(c, i) in serial.b16" :class="comparisonClass(serial.comparisonB16[i])">{{c}}</span>
                    </span><br/>
                </div>
                <br/>
                <span style="font-size: 14px;color: #888;">Overall - Match: {{Math.round(comparisonStatsB16.matches / comparisonStatsB16.total * 100)}}% / Diff: {{Math.round(comparisonStatsB16.differences / comparisonStatsB16.total * 100)}}% / Added: {{Math.round(comparisonStatsB16.additions / comparisonStatsB16.total * 100)}}%</span><br/>
                <span class="serial-b16 bigger">
                    <span v-for="(c, i) in comparisonStringB16" :class="comparisonClass(c)">{{c}}</span>
                </span><br/>
            </div>

            <!-- Base 4 Block -->
            <div class="serial-container" v-if="false">
                <div v-for="(serial, idx) in comparisonSerials" :key="'desc-b04-' + idx">
                    <span v-if="comparisonSerials.length > 2" style="font-size: 12px;color: #888;">Match: {{Math.round(serial.statsB04.matches / serial.statsB04.total * 100)}}% / Diff: {{Math.round(serial.statsB04.differences / serial.statsB04.total * 100)}}% / Added: {{Math.round(serial.statsB04.additions / comparisonStatsB04.total * 100)}}% <span style="margin-left: 24px;"></span> {{ serial.description }}</span>
                    <span v-else style="font-size: 12px;color: #888;">{{ serial.description }}</span><br/>
                    <span class="serial-b16 bigger">
                        <span v-for="(c, i) in serial.b04" :class="comparisonClass(serial.comparisonB04[i])">{{c}}</span>
                    </span><br/>
                </div>
                <br/>
                <span style="font-size: 14px;color: #888;">Overall - Match: {{Math.round(comparisonStatsB04.matches / comparisonStatsB04.total * 100)}}% / Diff: {{Math.round(comparisonStatsB04.differences / comparisonStatsB04.total * 100)}}% / Added: {{Math.round(comparisonStatsB04.additions / comparisonStatsB04.total * 100)}}%</span><br/>
                <span class="serial-b16 bigger">
                    <span v-for="(c, i) in comparisonStringB04" :class="comparisonClass(c)">{{c}}</span>
                </span><br/>
            </div>

            <!-- Base 2 Block -->
            <div class="serial-container">
                <div v-for="(serial, idx) in comparisonSerials" :key="'desc-b02-' + idx">
                    <span v-if="comparisonSerials.length > 2" style="font-size: 12px;color: #888;">Match: {{Math.round(serial.statsB02.matches / serial.statsB02.total * 100)}}% / Diff: {{Math.round(serial.statsB02.differences / serial.statsB02.total * 100)}}% / Added: {{Math.round(serial.statsB02.additions / serial.statsB02.total * 100)}}% <span style="margin-left: 24px;"></span> {{ serial.description }}</span>
                    <span v-else style="font-size: 12px;color: #888;">{{ serial.description }}</span><br/>
                    <span class="serial-b02 bigger">
                        <span v-for="(c, i) in serial.b02" :class="[comparisonClass(serial.comparisonB02[i]), binaryComparisonSpecialClasses(serial, serial.b02, i)]">{{c}}</span>
                    </span><br/>
                </div>
                <br/>
                <span style="font-size: 14px;color: #888;">Overall - Match: {{Math.round(comparisonStatsB02.matches / comparisonStatsB02.total * 100)}}% / Diff: {{Math.round(comparisonStatsB02.differences / comparisonStatsB02.total * 100)}}% / Added: {{Math.round(comparisonStatsB02.additions / comparisonStatsB02.total * 100)}}%</span><br/>
                <span class="serial-b02 bigger">
                    <span v-for="(c, i) in comparisonStringB02" :class="comparisonClass(c)">{{c}}</span>
                </span><br/>

                <button
                    class="dataset-load-btn"
                    style="margin-top: 12px;"
                    v-on:click="generateAllCombinations"
                    :disabled="!generateCombinationsPossible"
                >Generate all combinations</button>

                <div v-if="!generateCombinationsPossible">
                    <span style="font-size: 12px;color: #888;margin-top: 12px;display: inline-block;">Cannot generate combinations: serials are not aligned due to gaps.</span>
                </div>

            </div>
        </section>

        <div
            v-else
            class="serial-container"
            v-for="(serial, index) in serials"
            v-bind:style="{background: serial.selected ? serial.backgroundClear : serial.background}"
            v-on:click.self="serial.selected = !serial.selected"
        >
            <input type="checkbox" class="serial-select-checkbox" v-model="serial.selected"/>
            <input type="text" v-model="serial.description" class="serial-input-description" v-on:focus="onDescriptionFocus" v-on:blur="onDescriptionBlur(serial)">
            <span class="confbutton" style="font-size: 14px;margin-left: 8px;padding-top: 2px;padding-bottom: 2px;">{{ 'Level: ' + ((serial.itemLevelInfo && serial.itemLevelInfo.level !== null) ? serial.itemLevelInfo.level : '?') }}</span><br/>
            <span class="serial-b85">{{ serial.b85 }}</span><br/>
            <span class="serial-b16" v-on:click.self="serial.selected = !serial.selected">{{ serial.b16 }}</span><br/>
            <span v-if="false" class="serial-b16" v-on:click.self="serial.selected = !serial.selected">{{ serial.b04 }}</span>
            <span class="serial-b02" v-on:click.self="serial.selected = !serial.selected">
                <span v-for="(c, i) in serial.b02" :class="binarySpecialClasses(serial, i)">{{ c }}</span>
            </span><br/>
        </div>
    </div>

</div>

<script type="module">
    import {affineGapAlignment} from './lib/affineGapAlignment.js';
    import {randomColor} from './lib/crc32.js';
    import {b85Decode, b85Encode, base85GetByteOrder, base85ChangeByteOrder, base85GetReverseBits, base85SetReverseBits} from './lib/b85.js';
    import {hexToBin, hexToBase4, b16FromB02} from './lib/hex_to_bin.js';
    import {hexToInt, intToHex} from './lib/chr_hex.js';
    import {itemDecodeLevel} from "./lib/item_decode_read_level.js";
    import datasets from './lib/datasets.js';

    const { createApp, ref } = Vue

    function bitswapSerial(b85) {
        //b85 = '@UgeU_{Fme!Krh`(W3U#PP4HtS;PE<(LNYtjnpz5Ihp!%R{q0XU(G5`';
        let b16 = b85Decode(b85)

        let backpackCounter = 0;
        let output = '';
        for (let pos = 0; pos < b16.length; pos++) {
            for (let bit = 0; bit < 4; bit++) {
                let newItem = b16;

                let char = hexToInt(newItem[pos]);
                char ^= (1 << bit);
                newItem = newItem.substring(0, pos) + intToHex(char) + newItem.substring(pos + 1);

                // console.log(newItem);
                output += '        slot_' + backpackCounter + ':' + '\n';
                output += '          serial: \'' + b85Encode(newItem) + '\'' + '\n';

                backpackCounter++;
            }
        }
        return output;
    }

    // Clé localStorage pour la persistance
    const LOCAL_SERIALS_KEY = 'bl4_serials_v1';
    const LOCAL_BYTE_ORDER_KEY = 'bl4_byte_order_v1';

    createApp({
        data() {
            let defaultPlaceholder = 'Paste any serial type:  @Ugy3L+`$W...   8060e084220....   01101010101000011100....';

            // Load saved byte order from localStorage, or use default
            let savedByteOrder = null;
            try {
                savedByteOrder = localStorage.getItem(LOCAL_BYTE_ORDER_KEY);
            } catch (e) {
                console.warn('Failed to load byte order from localStorage', e);
            }

            // Validate saved byte order
            let initialByteOrder = base85GetByteOrder().join('');
            if (savedByteOrder && savedByteOrder.length === 4 && new Set(savedByteOrder).size === 4 && [...savedByteOrder].every(c => '0123'.includes(c))) {
                initialByteOrder = savedByteOrder;
                // Apply the saved byte order to the library
                const newOrder = [...savedByteOrder].map(c => parseInt(c));
                base85ChangeByteOrder(newOrder);
            }

            return {
                inputSerial: '',
                defaultPlaceholder: defaultPlaceholder,
                placeholder: defaultPlaceholder,

                serials: [],

                autoscrollEnabled: true,
                focused: false,

                comparisonEnabled: false,
                comparisonSerials: [], // Array of aligned serials
                realComparisonSerials: [], // Original serials being compared
                comparisonStringB85: null,
                comparisonStringB16: null,
                comparisonStringB02: null,
                comparisonStringB04: null,
                comparisonStatsB85: null,
                comparisonStatsB16: null,
                comparisonStatsB02: null,
                comparisonStatsB04: null,
                centerSerialIndex: null, // Index of the center serial used for alignment

                displayYamlResult: null, // Contains the result if opened

                mouseInsideHeader: false,

                // Flag interne pour bloquer les sauvegardes pendant le chargement
                _loading: false,

                showDatasetList: false, // Control visibility of the dataset loading section
                availableDatasets: datasets,

                lastByteOrder: initialByteOrder,
                byteOrder: initialByteOrder,

                byteOrderFocused: false,
                reverseBits: base85GetReverseBits(),
            };
        },

        created() {
            setTimeout(() => {
                document.addEventListener('mousemove', () => {
                    if (this.focused) return;
                    if (!this.comparisonEnabled && this.selectedSerials > 0) return;
                    if (!this.autoscrollEnabled) return;
                    if (this.byteOrderFocused) return;

                    if (this.mouseInsideHeader) {
                        this.$refs.serialsDiv.scrollLeft = 0;
                        return;
                    }

                    const w = window.innerWidth;
                    const margin = 0.12 * w; // 7% margin on each side
                    let perc = (event.clientX - margin) / (w - 2 * margin);
                    this.$refs.serialsDiv.scrollLeft = perc * (this.$refs.serialsDiv.scrollWidth - this.$refs.serialsDiv.clientWidth);
                }, false);
            }, 250);

            setTimeout(() => {
                // this.openComparisonWindow();
            }, 25)

            this.loadSavedSerials();
        },

        watch: {
            // Déclenché sur toute modification profonde (ajout, suppression, description modifiée)
            serials: {
                handler() {
                    this.saveSerialsDebounced();
                    if (this.selectedSerials > 0) {
                        this.$refs.serialsDiv.scrollLeft = 0;
                    }
                },
                deep: true
            },

            byteOrder() {
                if (!this.byteOrderValid) return;

                // Update the byte order in the b85 library
                const newOrder = [...this.byteOrder].map(c => parseInt(c));
                base85ChangeByteOrder(newOrder);
                this.lastByteOrder = this.byteOrder;

                // Save to localStorage
                try {
                    localStorage.setItem(LOCAL_BYTE_ORDER_KEY, this.byteOrder);
                } catch (e) {
                    console.warn('Failed to save byte order to localStorage', e);
                }

                // Re-encode all serials with the new byte order
                this.serials.forEach(serial => {
                    serial.b16 = b85Decode(serial.b85);
                    serial.b04 = hexToBase4(serial.b16);
                    serial.b02 = hexToBin(serial.b16);
                });

                // If comparison window is open, recompute all comparisons
                if (this.comparisonEnabled) {
                    this.openComparisonWindow();
                }
            },

            reverseBits() {
                base85SetReverseBits(this.reverseBits);

                // Re-encode all serials with the new bit order
                this.serials.forEach(serial => {
                    serial.b16 = b85Decode(serial.b85);
                    serial.b04 = hexToBase4(serial.b16);
                    serial.b02 = hexToBin(serial.b16);
                });

                // If comparison window is open, recompute all comparisons
                if (this.comparisonEnabled) {
                    this.openComparisonWindow();
                }
            },
        },

        methods: {
            binarySpecialClasses(serial, i) {
                let out = [];

                // Is the bit part of the level bits?
                if (serial.itemLevelInfo && i >= serial.itemLevelInfo.firstLevelBit && i < serial.itemLevelInfo.lastLevelBit)
                    out.push('b02-level-bits');

                return out;
            },

            binaryComparisonSpecialClasses(serial, paddedSerial, paddedPos) {
                // Problem: i has gaps, we need to figure out the real position in the original serial

                if (!serial.itemLevelInfo) return;
                let lastLevelBit = serial.itemLevelInfo.lastLevelBit;
                let i = 0;
                for (let j = 0; j < paddedPos; j++) {
                    // If it's zero or one, it's a real bit
                    if (paddedSerial[j] === '0' || paddedSerial[j] === '1')
                        i++;

                    if (i > lastLevelBit+5) {
                        // We've passed the level bits, stop here
                        break;
                    }
                }
                console.log('i =', i);
                console.log('serial =', serial);

                if (serial.itemLevelInfo && i >= serial.itemLevelInfo.firstLevelBit && i < serial.itemLevelInfo.lastLevelBit)
                    return 'b02-level-bits';

                return '';
            },

            reverseBitsButton() {
                this.reverseBits = !this.reverseBits;
            },

            generateAllCombinations() {
                if (!this.generateCombinationsPossible) return;
                // Debug
                // console.log(this.comparisonStringB02); // ======!!===!!===============
                // console.log(this.comparisonSerials[0].b02);

                // Count how many "!" are in the comparison string
                const diffPositions = [];
                for (let i = 0; i < this.comparisonStringB02.length; i++) {
                    // reverse from right to left
                    let j = this.comparisonStringB02.length - 1 - i;

                    if (this.comparisonStringB02[j] === '!')
                        diffPositions.push(j);
                }

                const totalCombinations = Math.pow(2, diffPositions.length);
                if (totalCombinations >= 2000)
                    if (!confirm('This will generate ' + totalCombinations + ' combinations. Continue?'))
                        return;

                let yamlResults = '';
                for (let combo = 0; combo < totalCombinations; combo++) {
                    let newB02 = this.comparisonSerials[0].b02.split('');
                    for (let bit = 0; bit < diffPositions.length; bit++) {
                        const pos = diffPositions[bit];
                        // From right to left, set bits in combo to determine 0/1
                        // Set the bit to 0 or 1 based on the current combination number
                        newB02[pos] = ((combo >> bit) & 1) ? '1' : '0';
                    }
                    newB02 = newB02.join('');
                    // console.log(newB02);

                    let b16 = b16FromB02(newB02);
                    let b85 = b85Encode(b16);
                    yamlResults += '        slot_' + combo + ':' + '\n';
                    yamlResults += '          serial: \'' + b85 + '\'' + '\n';
                }
                this.displayYamlResult = yamlResults;
            },

            exportSelectedToYaml() {
                if (this.selectedSerials === 0) return;
                let selected = this.serials.filter(s => s.selected);
                let output = '';
                selected.forEach((serial, index) => {
                    output += '        slot_' + index + ':' + '\n';
                    output += '          serial: \'' + serial.b85 + '\'' + '\n';
                });
                this.displayYamlResult = output;
            },

            byteOrderBlur() {
                if (!this.byteOrderValid) this.byteOrder = this.lastByteOrder;
                this.byteOrderFocused = false;
            },

            byteOrderFocus() {
                this.byteOrderFocused = true;
                this.$refs.serialsDiv.scrollLeft = 0;
            },

            bitswapSerial() {
                let selected = this.serials.filter(s => s.selected);
                if (selected.length !== 1) return;
                let serial = selected[0];
                let bitswaps = bitswapSerial(serial.b85);
                // console.log(bitswaps);
                this.displayYamlResult = bitswaps;
            },

            comparisonClass(comparisonCharacter) {
                switch(comparisonCharacter) {
                    case '=': return 'comparison-match';
                    case '!': return 'comparison-diff';
                    case '+': return 'comparison-add';
                    default: return '';
                }
            },

            openComparisonWindow() {
                if (this.selectedSerials < 2) return;
                let selected = this.serials.filter(s => s.selected);
                this.realComparisonSerials = selected.slice();

                // Deselect all
                // selected.forEach(s => s.selected = false);

                // Shortcut for two-serial comparison: use direct affineGapAlignment
                if (selected.length === 2) {
                    const serial1 = selected[0];
                    const serial2 = selected[1];

                    // Perform direct pairwise alignments for each base type
                    const align85 = affineGapAlignment(serial1.b85, serial2.b85);
                    const align16 = affineGapAlignment(serial1.b16, serial2.b16);
                    const align02 = affineGapAlignment(serial1.b02, serial2.b02, 5, -4, -20, -2);
                    const align04 = affineGapAlignment(serial1.b04, serial2.b04);

                    // Build comparison serials directly from affineGapAlignment results
                    this.comparisonSerials = [
                        {
                            b85: align85.alignedA,
                            b16: align16.alignedA,
                            b02: align02.alignedA,
                            b04: align04.alignedA,
                            background: serial1.background,
                            description: serial1.description,
                            comparisonB85: align85.comparison,
                            comparisonB16: align16.comparison,
                            comparisonB02: align02.comparison,
                            comparisonB04: align04.comparison,
                            statsB85: align85.stats,
                            statsB16: align16.stats,
                            statsB02: align02.stats,
                            statsB04: align04.stats,
                            itemLevelInfo: serial1.itemLevelInfo,
                        },
                        {
                            b85: align85.alignedB,
                            b16: align16.alignedB,
                            b02: align02.alignedB,
                            b04: align04.alignedB,
                            background: serial2.background,
                            description: serial2.description,
                            comparisonB85: align85.comparison,
                            comparisonB16: align16.comparison,
                            comparisonB02: align02.comparison,
                            comparisonB04: align04.comparison,
                            statsB85: align85.stats,
                            statsB16: align16.stats,
                            statsB02: align02.stats,
                            statsB04: align04.stats,
                            itemLevelInfo: serial2.itemLevelInfo,
                        }
                    ];

                    // Set global comparison strings (same for both serials in 2-serial case)
                    this.comparisonStringB85 = align85.comparison;
                    this.comparisonStringB16 = align16.comparison;
                    this.comparisonStringB02 = align02.comparison;
                    this.comparisonStringB04 = align04.comparison;

                    this.comparisonStatsB85 = align85.stats;
                    this.comparisonStatsB16 = align16.stats;
                    this.comparisonStatsB02 = align02.stats;
                    this.comparisonStatsB04 = align04.stats;

                    this.centerSerialIndex = null; // Not applicable for direct comparison

                    this.comparisonEnabled = true;
                    return;
                }

                // For 3+ serials, require all to have the same hex length and use simple comparison

                // Check that all serials have the same hex length
                const firstHexLength = selected[0].b16.length;
                const allSameLength = selected.every(s => s.b16.length === firstHexLength);

                if (!allSameLength) {
                    alert('Multi-serial comparison requires all serials to have the same hex length. Please select serials with matching lengths.');
                    // Re-select all serials
                    // selected.forEach(s => s.selected = true);
                    this.realComparisonSerials = [];
                    return;
                }

                // Simple character-by-character comparison for 3+ serials
                const computeSimpleComparison = (seqA, seqB) => {
                    let comparison = '';
                    let matches = 0, differences = 0;
                    const len = seqA.length;

                    for (let i = 0; i < len; i++) {
                        if (seqA[i] === seqB[i]) {
                            comparison += '=';
                            matches++;
                        } else {
                            comparison += '!';
                            differences++;
                        }
                    }

                    return { comparison, stats: { matches, differences, additions: 0, total: len } };
                };

                // Use first serial as reference
                this.centerSerialIndex = 0;
                const referenceSerial = selected[0];

                // Build comparison serials with simple character comparison
                this.comparisonSerials = selected.map((serial, idx) => {
                    const compB85 = computeSimpleComparison(serial.b85, referenceSerial.b85);
                    const compB16 = computeSimpleComparison(serial.b16, referenceSerial.b16);
                    const compB02 = computeSimpleComparison(serial.b02, referenceSerial.b02);
                    const compB04 = computeSimpleComparison(serial.b04, referenceSerial.b04);

                    return {
                        b85: serial.b85,
                        b16: serial.b16,
                        b02: serial.b02,
                        b04: serial.b04,
                        background: serial.background,
                        description: serial.description,
                        comparisonB85: compB85.comparison,
                        comparisonB16: compB16.comparison,
                        comparisonB02: compB02.comparison,
                        comparisonB04: compB04.comparison,
                        statsB85: compB85.stats,
                        statsB16: compB16.stats,
                        statsB02: compB02.stats,
                        statsB04: compB04.stats,
                        itemLevelInfo: serial.itemLevelInfo,
                    };
                });

                // Compute global comparison (aggregate view)
                const computeGlobalComparison = (comparisons) => {
                    const len = comparisons[0].length;
                    let global = '';
                    let stats = { matches: 0, differences: 0, additions: 0, total: len };

                    for (let i = 0; i < len; i++) {
                        const chars = comparisons.map(c => c[i]);
                        const allEqual = chars.every(ch => ch === chars[0]);

                        if (allEqual && chars[0] === '=') {
                            global += '=';
                            stats.matches++;
                        } else {
                            global += '!';
                            stats.differences++;
                        }
                    }
                    return { comparison: global, stats };
                };

                const globalB85 = computeGlobalComparison(this.comparisonSerials.map(s => s.comparisonB85));
                const globalB16 = computeGlobalComparison(this.comparisonSerials.map(s => s.comparisonB16));
                const globalB02 = computeGlobalComparison(this.comparisonSerials.map(s => s.comparisonB02));
                const globalB04 = computeGlobalComparison(this.comparisonSerials.map(s => s.comparisonB04));

                this.comparisonStringB85 = globalB85.comparison;
                this.comparisonStringB16 = globalB16.comparison;
                this.comparisonStringB02 = globalB02.comparison;
                this.comparisonStringB04 = globalB04.comparison;

                this.comparisonStatsB85 = globalB85.stats;
                this.comparisonStatsB16 = globalB16.stats;
                this.comparisonStatsB02 = globalB02.stats;
                this.comparisonStatsB04 = globalB04.stats;

                this.comparisonEnabled = true;
            },

            stopComparingSerials() {
                this.comparisonEnabled = false;
                // this.realComparisonSerials.forEach(s => s.selected = true);
                this.realComparisonSerials = [];
                this.comparisonSerials = [];
                this.comparisonStringB85 = null;
                this.comparisonStringB16 = null;
                this.comparisonStringB02 = null;
                this.comparisonStringB04 = null;
                this.comparisonStatsB85 = null;
                this.comparisonStatsB16 = null;
                this.comparisonStatsB02 = null;
                this.comparisonStatsB04 = null;
                this.$refs.serialsDiv.scrollLeft = 0;
            },

            clickToggleAutoscroll() {
                if (this.focused || this.selectedSerials > 0) return;
                this.autoscrollEnabled = !this.autoscrollEnabled;
            },

            toggleSelectAll() {
                const newState = !this.allSelected;
                this.serials.forEach(s => s.selected = newState);
            },

            onDescriptionFocus() {
                this.focused = true;
                this.$refs.serialsDiv.scrollLeft = 0;
            },

            onDescriptionBlur(serial) {
                // Rétablir le flag focus et sauvegarder (debounce)
                this.focused = false;
                // Sauvegarder uniquement b85 + description
                this.saveSerialsDebounced();
            },

            preventTyping(evt) {
                this.placeholder = ' Only paste is allowed!';
                setTimeout(() => {
                    this.placeholder = this.defaultPlaceholder;
                }, 1250);

                evt.preventDefault();
                return false;
            },

            onPaste() {
                if (this.comparisonEnabled) this.stopComparingSerials();

                window.requestAnimationFrame(() => {
                    this.$nextTick(() => {
                        let data = this.inputSerial;
                        this.inputSerial = '';

                        // Split data lines by newlines
                        const lines = data.split(/\r?\n/);

                        lines.forEach(line => {
                            line = line.trim();
                            if (line)
                                this.pushRawSerial(line)
                        });
                    });
                });
            },

            pushRawSerial(str, name=null) {
                // Detect type of serial
                if (str.startsWith('@U')) {
                    let b85 = str;
                    let b16 = b85Decode(str);
                    let b02 = hexToBin(b16);
                    let b04 = hexToBase4(b16);

                    this.pushSerial({b85, b16, b02, b04}, name);
                    return;
                }

                str = str.replaceAll(' ', '');
                if (str.startsWith('0x')) str = str.slice(2);
                if (str.startsWith('0b')) str = str.slice(2);

                let containsOnlyB02 = /^[01]+$/.test(str);
                if (containsOnlyB02) {
                    if (str.length % 8 !== 0) {
                        // TODO: warning about odd length
                        return;
                    }

                    let b02 = str;
                    let b16 = b16FromB02(b02);
                    let b85 = b85Encode(b16);
                    let b04 = hexToBase4(b16);
                    this.pushSerial({b85, b16, b02, b04}, name);
                    return;
                }

                let containsOnlyB16 = /^[0-9a-fA-F]+$/.test(str);
                if (containsOnlyB16) {
                    if (str.length % 2 !== 0) {
                        // TODO: warning about odd length
                        return;
                    }

                    let b16 = str.toLowerCase();
                    let b85 = b85Encode(b16);
                    let b02 = hexToBin(b16);
                    let b04 = hexToBase4(b16);

                    this.pushSerial({b85, b16, b02, b04}, name);
                    return;
                }

                // TODO: warning about unknown format
            },

            pushSerial(serialObj, name=null) {
                // Figure out the item level, if possible
                let itemLevelInfo = itemDecodeLevel(serialObj.b02);

                // RGB values for background
                let color1 = randomColor(serialObj.b85, 3, 0.2);
                let color2 = randomColor(serialObj.b16, 3, 0.2);
                let color3 = randomColor(serialObj.b02, 3, 0.2);

                // Compute the background strings
                let background = `linear-gradient(90deg, ${color1} 0%, ${color2} 50%, ${color3} 100%)`;

                color1 = randomColor(serialObj.b85, 1.5, 0.65);
                color2 = randomColor(serialObj.b16, 1.5, 0.65);
                color3 = randomColor(serialObj.b02, 1.5, 0.65);
                let backgroundClear = `linear-gradient(90deg, ${color1} 0%, ${color2} 50%, ${color3} 100%)`;

                this.serials.unshift({
                    ...serialObj,
                    background,
                    backgroundClear,
                    selected: false,
                    description: name || 'Untitled serial ' + (this.serials.length + 1),
                    itemLevelInfo,
                });
                // Sauvegarde après insertion (debounce) sauf si on est en cours de chargement initial
                if (!this._loading) this.saveSerialsDebounced();
            },

            generateComparisonString(str1, str2) {
                if (str1.length !== str2.length) {
                    let temp = str1;
                    str1 = str2;
                    str2 = temp;
                }

                let comparison = '';
                for (let i = 0; i < str1.length; i++)
                    comparison += str1[i] === str2[i] ? '=' : '!';

                return comparison;
            },

            saveSerials() {
                try {
                    const minimal = this.serials.map(s => ({ b85: s.b85, description: s.description }));
                    localStorage.setItem(LOCAL_SERIALS_KEY, JSON.stringify(minimal));
                } catch (e) {
                    console.warn('Failed to save serials to localStorage', e);
                }
            },

            saveSerialsDebounced() {
                if (this._saveTimeout) clearTimeout(this._saveTimeout);
                this._saveTimeout = setTimeout(() => this.saveSerials(), 250);
            },

            loadSavedSerials() {
                try {
                    const raw = localStorage.getItem(LOCAL_SERIALS_KEY);
                    console.log(raw);
                    if (!raw) return false;
                    const arr = JSON.parse(raw);
                    if (!Array.isArray(arr)) return false;
                    if (arr.length === 0) return false;
                    this._loading = true;
                    // Insérer en ordre en inversant (unshift utilisé dans pushSerial)
                    let hasAddedSomething = false;
                    for (let i = arr.length - 1; i >= 0; i--) {
                        const item = arr[i];
                        if (!item || !item.b85) continue;
                        this.pushRawSerial(item.b85);
                        hasAddedSomething = true;
                        if (this.serials[0]) this.serials[0].description = item.description || this.serials[0].description;
                    }
                    if (!hasAddedSomething) return false;
                } catch (e) {
                    console.warn('Failed to load serials from localStorage', e);
                } finally {
                    this._loading = false;
                    // Sauvegarde unique post-chargement pour normaliser (ex: si format évolue plus tard)
                    this.saveSerialsDebounced();
                }

                return true;
            },

            loadDataset(dataset) {
                // Implement dataset loading logic here
                console.log('Loading dataset:', dataset.name);
                // For example, you might fetch the dataset from a server and then add the serials to the app
                this.showDatasetList = false; // Close the dataset list after loading

                // Erase all current serials
                this.serials = [];
                this.saveSerialsDebounced();

                for (let i = dataset.items.length - 1; i >= 0; i--) {
                    const item = dataset.items[i];
                    this.pushRawSerial(item.b85, (dataset.prefix || '') + item.name);
                }
            },
        },

        computed: {
            generateCombinationsPossible() {
                if (!this.comparisonEnabled) return false;

                // Impossible to generate combinations if any additions are present in the comparison
                return this.comparisonStringB02 && !this.comparisonStringB02.includes('+');
            },

            selectedSerials() {
                return this.serials.filter(s => s.selected).length;
            },
            allSelected() {
                return this.serials.length > 0 && this.serials.every(s => s.selected);
            },

            byteOrderValid() {
                if (this.byteOrder.length !== 4) return false;
                if (new Set(this.byteOrder).size !== 4) return false;
                if (![...this.byteOrder].every(c => '0123'.includes(c))) return false;
                return true;
            },
        },
    }).mount('#app')
</script>
</body>
</html>
